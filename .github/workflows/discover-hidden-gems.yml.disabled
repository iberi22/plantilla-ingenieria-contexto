name: ğŸ” Hidden Gems Discovery Pipeline

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      tier:
        description: 'Repository tier (micro/small/medium)'
        required: true
        default: 'small'
        type: choice
        options:
          - micro
          - small
          - medium
      max_repos:
        description: 'Maximum number of repos to approve'
        required: true
        default: '3'
        type: string

env:
  RUST_LOG: info

jobs:
  discover-hidden-gems:
    name: ğŸš€ Discover & Analyze Repositories
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¦€ Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“ Create Output Directory
        run: |
          mkdir -p output
          echo "Output directory created"

      - name: ğŸ”¨ Build Rust Scanner
        working-directory: ./rust-scanner
        run: |
          echo "ğŸ”¨ Building Rust scanner with release optimizations..."
          cargo build --release --bin complete-analyzer
          echo "âœ… Build complete"

      - name: ğŸ” Phase 1 & 2 - Rust Analysis (Parallel)
        id: rust-analysis
        working-directory: ./rust-scanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TIER="${{ github.event.inputs.tier || 'small' }}"
          MAX_REPOS="${{ github.event.inputs.max_repos || '3' }}"

          echo "ğŸš€ Starting Rust analysis..."
          echo "   Tier: $TIER"
          echo "   Max repos: $MAX_REPOS"

          # Run Rust analyzer and capture output
          ./target/release/complete-analyzer "$TIER" "$MAX_REPOS" > ../output/rust_analysis.log 2>&1

          # Extract JSON results
          sed -n '/__RESULTS_JSON__/,/__END_JSON__/p' ../output/rust_analysis.log | \
            grep -v '__RESULTS_JSON__' | \
            grep -v '__END_JSON__' > ../output/rust_results.json

          echo "âœ… Rust analysis complete"
          cat ../output/rust_analysis.log | grep -E "ğŸ‰|Approved|analyzed"

      - name: ğŸ¤– Phase 3 - AI Review (Python + GitHub Models)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ¤– Starting AI review with GitHub Models API..."
          python scripts/ai_review_from_rust.py output/rust_results.json output/with_ai_review.json
          echo "âœ… AI review complete"

      - name: ğŸ“ Phase 4 - Blog Generation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“ Generating blog posts..."
          python scripts/generate_blogs_from_analysis.py output/with_ai_review.json
          echo "âœ… Blog generation complete"

      - name: ğŸ“Š Summary Report
        run: |
          echo "## ğŸ“Š Discovery Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f output/with_ai_review.json ]; then
            APPROVED=$(jq '[.[] | select(.recommendation == "APPROVE")] | length' output/with_ai_review.json)
            TOTAL=$(jq 'length' output/with_ai_review.json)

            echo "- **Total Analyzed**: $TOTAL repositories" >> $GITHUB_STEP_SUMMARY
            echo "- **Approved**: $APPROVED repositories" >> $GITHUB_STEP_SUMMARY
            echo "- **Blog Posts Generated**: $APPROVED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### âœ… Approved Repositories" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | select(.recommendation == "APPROVE") | "- **\(.repo)** - Score: \(.total_score)/100"' output/with_ai_review.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Commit New Blog Posts
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [ -n "$(git status --porcelain website/src/content/blog/)" ]; then
            git add website/src/content/blog/*.md
            git add output/*.json
            git commit -m "ğŸ¤– Discover hidden gems: $(date +'%Y-%m-%d')"
            git push
            echo "âœ… New blog posts committed"
          else
            echo "â„¹ï¸ No new blog posts to commit"
          fi

      - name: ğŸ“ Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: analysis-results-${{ github.run_number }}
          path: output/
          retention-days: 30
          if-no-files-found: warn
