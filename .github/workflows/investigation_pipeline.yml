name: Investigation Pipeline

on:
  push:
    branches: [ main ]
  schedule:
    # Run every 6 hours (4 times a day)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Mode: check (updates) or discover (new)'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - discover

permissions:
  contents: write
  pull-requests: write

jobs:
  manage-investigations:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Important for git history if needed

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Setup Rust (for faster scanner)
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Build Rust Scanner
      id: rust_build
      run: |
        echo "ðŸ¦€ Building Rust scanner..."
        cd rust-scanner
        if cargo build --release; then
          echo "âœ… Rust scanner built successfully"
          echo "rust_available=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Rust scanner build failed, will use Python fallback"
          echo "rust_available=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true  # Don't fail if Rust build fails, Python fallback exists

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Debug Environment
      run: |
        echo "ðŸ” Debugging environment variables..."
        echo "Event name: ${{ github.event_name }}"
        echo "Input mode: ${{ inputs.mode }}"
        echo "GITHUB_TOKEN present: ${{ secrets.GITHUB_TOKEN != '' }}"
        echo "GOOGLE_API_KEY present: ${{ secrets.GOOGLE_API_KEY != '' }}"
        echo "GH_PAT present: ${{ secrets.GH_PAT != '' }}"

    - name: Run Blog Generation Workflow
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_API_KEY_2: ${{ secrets.GOOGLE_API_KEY_2 }}
        GOOGLE_API_KEY_3: ${{ secrets.GOOGLE_API_KEY_3 }}
        GOOGLE_API_KEY_4: ${{ secrets.GOOGLE_API_KEY_4 }}
        GOOGLE_API_KEY_5: ${{ secrets.GOOGLE_API_KEY_5 }}
        RUST_LOG: info
      run: |
        echo "ðŸš€ Starting blog generation workflow..."
        echo "Event: ${{ github.event_name }}"
        echo "Rust build status: ${{ steps.rust_build.outputs.rust_available }}"

        # Verify secrets are loaded
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "âŒ ERROR: GITHUB_TOKEN is empty!"
          exit 1
        fi

        if [ -z "$GOOGLE_API_KEY" ]; then
          echo "âŒ ERROR: GOOGLE_API_KEY is empty!"
          exit 1
        fi

        echo "âœ… Secrets loaded successfully"

        if [ "${{ github.event_name }}" == "schedule" ]; then
          echo "ðŸ“… Running scheduled blog generation..."
          python scripts/workflow_generate_blog.py
        elif [ "${{ inputs.mode }}" == "discover" ]; then
          echo "ðŸ” Running manual blog generation (discover mode)..."
          python scripts/workflow_generate_blog.py
        else
          echo "ðŸ”Ž Running scanner only..."
          python scripts/run_scanner.py
        fi

        # Generate Images using Gemini
        echo "ðŸŽ¨ Checking for missing images..."
        python image-generation/generate_images_gemini.py

        # Sync images to public folder
        echo "ðŸ”„ Syncing images to public..."
        python scripts/sync_images_to_public.py

    - name: Check for changes
      id: git-check
      run: |
        # Add blog posts (always exists)
        git add website/src/content/blog/ || true
        # Add images if directory exists
        if [ -d "website/public/images" ]; then
          git add website/public/images/
        fi
        if git diff --staged --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and Push
      if: steps.git-check.outputs.changes == 'true'
      run: |
        git commit -m "chore: Update investigations and blog posts [skip ci]"
        git push
