---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.svelte';
import Directory from '../components/Directory.svelte';
import { getCollection } from 'astro:content';
import { ProjectCategory, type Project } from '../types';

// Fetch real blog posts
const blogPosts = await getCollection('blog');

// Map blog posts to Project interface
const realProjects: Project[] = blogPosts.map((post) => {
  const data = post.data;

  // Determine category based on tags or default
  let category = ProjectCategory.AI_TOOLS; // Default
  if (data.tags && data.tags.some(t => t.toLowerCase().includes('security'))) category = ProjectCategory.CYBERSECURITY;
  if (data.tags && data.tags.some(t => t.toLowerCase().includes('ui') || t.toLowerCase().includes('css'))) category = ProjectCategory.UI_UX;
  if (data.tags && data.tags.some(t => t.toLowerCase().includes('database') || t.toLowerCase().includes('sql'))) category = ProjectCategory.DATABASES;

  // Calculate relative time for last commit
  let lastCommitDisplay = 'Recently';
  if (data.insights?.last_commit_date) {
    const lastCommitDate = new Date(data.insights.last_commit_date);
    const now = new Date();
    const diffTime = Math.abs(now.getTime() - lastCommitDate.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 0) lastCommitDisplay = 'Today';
    else if (diffDays === 1) lastCommitDisplay = 'Yesterday';
    else lastCommitDisplay = `${diffDays} days ago`;

    // Format date: DD/MM/YYYY
    const dateStr = lastCommitDate.toLocaleDateString('en-GB');
    lastCommitDisplay = `${dateStr} (${lastCommitDisplay})`;
  }

  return {
    id: post.slug,
    name: data.repo ? data.repo.split('/')[1] : data.title,
    description: data.description || data.title, // Use title as description if missing
    url: data.repo ? `https://github.com/${data.repo}` : '#',
    category: category,
    tags: data.tags || [],
    logo: 'ðŸ“¦', // Default logo
    image: data.images?.screenshot,
    publishDate: data.date.toISOString().split('T')[0],
    author: 'AI Analyst',
    longContent: post.body,
    insights: {
      stars: data.stars || 0,
      forks: 0, // Not currently in frontmatter
      openIssues: data.insights?.open_issues_count || 0,
      seriousIssuesCount: 0, // We don't have this yet, maybe infer?
      lastCommit: lastCommitDisplay,
      summary: data.title
    }
  };
});

// Sort by date descending
realProjects.sort((a, b) => new Date(b.publishDate || '').getTime() - new Date(a.publishDate || '').getTime());

// Combine or replace hardcoded projects.
// For now, let's use ONLY real projects if they exist, otherwise fall back to sample for dev.
const projectsToDisplay = realProjects.length > 0 ? realProjects : [];

// SEO data
const pageDescription = `Discover ${projectsToDisplay.length}+ curated open source projects. AI-powered reviews of trending GitHub repositories, developer tools, and software. Find the best open source alternatives and hidden gems.`;
---

<Layout
  title="Directory"
  description={pageDescription}
  type="website"
>
  <main>
		<Hero client:load projects={projectsToDisplay} />

    <div id="directory" class="min-h-screen bg-dark-bg relative z-10">
      <Directory client:visible projects={projectsToDisplay} />
    </div>
	</main>
</Layout>
